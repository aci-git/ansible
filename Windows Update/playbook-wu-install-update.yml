---
- name: Windows Update
  hosts: rdc-dev-01.affordablecare.com
  gather_facts: no

  vars:
    update_log: C:\Windows\Temp\ansible-win-updates.log

  tasks:
    - name: Check for Windows updates
      win_updates:
        state: searched
        log_path: "{{ update_log }}"
      changed_when: false
      register: update_list

    - name: Install Windows updates
      win_updates:
        state: installed
        log_path: "{{ update_log }}"
      async: 7200
      poll: 60  
      register: win_update
      async_dir: C:\Windows\Temp

    - name: Wait for update install to complete
      async_status:
        jid: "{{ win_update.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 300

    - name: Output update install result
      debug:
        var: win_update

    - name: List installed updates
      win_shell: Get-Content {{ update_log }}
      register: updates_list
    - debug:
        var: updates_list.stdout_lines
