- hosts: all

  tasks:

    - name: Check for pending reboot
      win_shell: |
        $pendingReboot = Invoke-Command -ScriptBlock {
            $pendingRegistryKeys = @(
                r'HKLM:\SOFTWARE\RebootCheck\RebootPending',
                r'HKLM:\SOFTWARE\RebootCheck\RebootRequired',
                r'HKLM:\SYSTEM\RebootCheck\RebootPending'  
            )

            foreach ($registryKey in $pendingRegistryKeys) {
                if (Test-Path -Path $registryKey) {
                    return $true
                }
            }

            return $false
        }

        $output = "Reboot Pending: $pendingReboot"
        Write-Output $output

      register: reboot_result

    - debug:
        var: reboot_result

    - name: Output reboot status
      debug:
        msg: "{{ reboot_result.stdout }}"
