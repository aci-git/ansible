---
- hosts: all
  gather_facts: no
   
  tasks:

    - name: Get last boot time
      win_registry:
        path: HKLM:\System\CurrentControlSet\Control\Windows
        name: LastBootUpTime
      register: uptime
            
    - set_fact:
        last_rebooted: "{{ uptime.value | int | strftime('%Y-%m-%d %H:%M:%S') }}"

    - name: Check PendingFileRenameOperations registry key
      win_reg_stat:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\PendingFileRenameOperations 
      register: pending_file_rename

    - name: Print last boot time
      debug:
        var: last_rebooted
        
      when: pending_file_rename.exists
