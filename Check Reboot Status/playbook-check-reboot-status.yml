---
- hosts: all  
  gather_facts: no
   
  tasks:

    - name: Get last reboot time
      win_reg_stat:
        path: HKLM:\System\CurrentControlSet\Control\Windows  
        name: LastBootUpTime
      register: uptime

    - name: Set last rebooted time
      set_fact:
        last_rebooted: "{{ uptime.data | int | strftime('%Y-%m-%d %H:%M:%S') }}"

    - name: Check registry keys
      win_reg_stat:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\PendingFileRenameOperations
        gather_facts: no
      register: pending_file_rename

    - name: Print reboot status
      debug:
        msg: "System requires reboot"
      when:
        - pending_file_rename.exists
        
    - name: Print last rebooted time  
      debug:
        var: last_rebooted
