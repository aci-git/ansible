---
- name: Upgrade Windows Server
  hosts: 2016-TEST.affordablecare.com

  vars:
    setup_exe_path: E:\sources\setup.exe
    edition_map:
      ServerStandard: ServerStandard-Eval
      ServerDatacenter: ServerDatacenter-Eval

  tasks:

    - name: Get facts
      win_gather_facts:

    - name: Get current edition
      win_product_facts:
      register: current_edition

    - name: Set upgrade edition
      set_fact:
        upgrade_edition: "{{ edition_map[current_edition.products[0].product_name] }}"

    - name: Set upgrade command  
      set_fact:
        upgrade_cmd: "{{ setup_exe_path }} /upgrade {{ upgrade_edition }} /passive"

    - name: Perform upgrade
      win_command: "{{ upgrade_cmd }}"

    - block:

        - name: Check for updates
          win_updates:
            state: searched
        
        - name: Install updates
          win_updates:
            category_names:
              - CriticalUpdates
              - SecurityUpdates
            state: installed
          register: update_result
          until: not update_result.reboot_required  
          retries: 5
          delay: 10
          
      tags: patch

    - name: Verify upgrade success
      win_command: ver

    - name: Reboot server
      win_reboot:
      when: ver.rc != 0
