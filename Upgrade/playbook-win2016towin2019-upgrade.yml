---
- hosts: 2016-test.affordablecare.com 
  gather_facts: no
  
  tasks:

    - name: Check if AutoPilot module loaded
      win_command: Get-Module AutoPilotUpgrade
      register: module_check

    - name: Import AutoPilotUpgrade module
      win_psmodule:
        name: AutoPilotUpgrade
        state: present
      when: module_check.rc != 0

    - name: Set up upgrade task
      win_command: Save-AutoPilotUpgradeTask -Group 2 -PurgeExcessUpdates -DynamicUpdate Disabled

    - name: Perform upgrade to 2019  
      win_command: Start-AutoPilotUpgradeTask

    - name: Await completion  
      win_command: Get-AutoPilotUpgradeTaskInfo
      register: result
      until: result.stdout.Contains("The upgrade completed successfully")
      retries: 500
      delay: 30
      
    - name: Reboot server
      win_reboot:
      
  handlers:
    
    - name: reset connection
      meta: reset_connection
