- hosts: 2016-test

  tasks:

    - name: Run setup.exe from extracted ISO  
      win_command:
        chdir: C:\Temp\Sources\Install.wim
        cmd: C:\Temp\setup.exe /unattend:C:\Temp\unattend.xml

    - name: Await reboot
      win_reboot:
      when: ansible_reboot_pending

    - name: Wait for winrm to reconnect
      wait_for_connection:
        delay: 30
        timeout: 300

    - name: Verify upgrade success
      win_command: ver
      register: version

    - name: Assert upgrade completed
      assert:
        that:
          - version.stdout is match('OS Version.*2022')
