# Install collection
ansible-galaxy collection install community.windows

---
- hosts: 2016-test.affordablecare.com
  collections:
    - community.windows

  tasks:
    - name: Get full inventory facts
      community.windows.win_inventory:
        register: inventory_facts

    - name: Display OS facts
      debug:
        var: inventory_facts.os

    - name: Check for AutoPilot  
      community.windows.win_stat:
        path: $env:ProgramFiles\WindowsPowerShell\Modules\AutoPilotUpgrade\AutoPilotUpgrade.psm1
      register: module_check
      ignore_errors: true

    - name: Import AutoPilot
      community.windows.win_psmodule:
        name: AutoPilotUpgrade
        state: present
      when: not module_check.stat.exists  
      tags:
        - import

    - name: Set up upgrade task
      community.windows.win_command: Save-AutoPilotUpgradeTask -DynamicUpdate Disabled
      ignore_errors: true
      tags:
        - upgrade

    - name: Perform upgrade
      community.windows.win_command: Start-AutoPilotUpgradeTask 
      ignore_errors: true

    - name: Reboot server
      community.windows.win_reboot:
    
    - name: Wait for machine to come back online  
      wait_for_connection:
        delay: 30
        timeout: 300

    - name: Get upgrade results
      community.windows.win_command: Get-AutoPilotUpgradeTask
      register: upgrade_result
      changed_when: false

    - name: Display upgrade results  
      debug:
        var: upgrade_result