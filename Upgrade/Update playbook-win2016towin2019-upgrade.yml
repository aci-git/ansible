---
- hosts: 2016-test.affordablecare.com
  collections:
    - community.windows

  handlers:
    - name: restart server
      community.windows.win_reboot:

  tasks:
    - name: Get full inventory facts
      community.windows.win_inventory:
        register: inventory_facts

    - name: Set up upgrade task
      community.windows.win_command: Save-AutoPilotUpgradeTask -DynamicUpdate Disabled
      args:
        creates: C:\Windows\Temp\upgrade_task
      notify: restart server
      failed_when: false

    - name: Perform upgrade  
      community.windows.win_command: Start-AutoPilotUpgradeTask
      removes: C:\Windows\Temp\upgrade_task
      notify: restart server
      failed_when: false

    - name: Reboot server
      community.windows.win_reboot:

    - name: Wait for machine to come back online
      wait_for_connection:
        delay: 30
        timeout: 300

    - name: Get upgrade results  
      community.windows.win_command: Get-AutoPilotUpgradeTask
      register: upgrade_result
      failed_when: upgrade_result.rc != 0

    - name: Display upgrade results
      debug:
        var: upgrade_result
